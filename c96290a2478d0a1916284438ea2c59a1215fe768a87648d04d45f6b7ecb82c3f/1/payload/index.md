Decentralize Treasury Spending
## Abstract

Spending from the Decred treasury is a manual process that is executed and governed by humans.  The current process requires contractors to each produce a monthly invoice with a reimbursement report, denominated in USD, that is submitted to the project treasury auditors.  If the invoice is approved a payout is made to the contractor-provided address from the treasury funds, using an averaged DCR/USD exchange rate over the month the invoice applies to.  These payouts are made by Decred Holdings Group LLC (“DHG” for short), a conventional corporate entity which holds the treasury funds.

This process is centralized and it creates a potential single point of failure. To decentralize the process of spending from the treasury, we propose a 2-step process, where (1) a Politeia (“Pi” for short) identity key is used to generate a signed draft spending transaction and (2) this draft transaction is published on-chain, where stakeholders will vote to approve the transaction over a period of several days following it being published.  Prior to the draft transaction being published on-chain, stakeholders will have the opportunity to inspect the proposed spending on the Pi platform and ensure it adheres to proposals already passed on Pi.  Stakeholders will have the ability to change a single setting in dcrwallet such that they vote to approve or disapprove of draft transactions made by the Pi draft key.

## Motivation

At this present time all Decred treasury payouts are handled by DHG. This is undesirable for various reasons, such as

* sovereignty over treasury spends is not vested in the stakeholders
* risk of theft of funds
* risk of key project members abandoning the project
* risk of coercion being used against key project members
* process of treasury spending is insufficiently transparent

The proposed solution will semi-automate the release of treasury funds while diminishing key project members’ influence over the treasury spends.

## Implementation

The operators of Pi will aggregate all invoices generated by contractors or any other approved expenses each month and generate a single draft treasury spend for the entire amount. This transaction will be published off-chain on Pi for all to see and verify. Stakeholders will be given the opportunity to approve the draft transaction on-chain, assuming there are no serious problems with the draft transaction published on Pi.

If the transaction is voted down it will need to be reviewed and potentially broken up to deal with contention. Follow-up votes will determine the fate of individual costs.  If the treasury transaction is approved it will be published on-chain and the contractors will be able to redeem their individual payouts.

One attack vector that was observed early in the design process is that Voting Service Providers, i.e. stakepools (“VSPs” for short), are voting on the behalf of individuals and can therefore alter a stakeholder’s voting preferences. In order to combat collusion there will be audit tools built into the Decred wallet. These tools will observe and alert the user if a VSP is not voting correctly on their behalf. If this happens, a stakeholder will be able to raise an alert to warn other stakeholders to pay attention and take action.

The astute readers noticed that only the Pi operators can generate this transaction and that the process is therefore not completely decentralized. The authors of this proposal recognize and dislike this design decision. Without a Pi draft key, it is possible for stakeholders to collude and drain the treasury, which would have a serious negative impact on the sustainability of Decred.  This particular failure mode is documented in greater detail in the threat modeling section of this document. Pros and cons were weighed and we felt that the risk of exposing the entire treasury in a monolithic fashion is simply too large. There is a desire to remove this final guardrail, however, further measures will be addressed in future proposals. Note that the only malicious actions the Pi operators can take in this design is either not publishing draft transactions or publishing malicious draft transactions.  The stakeholders retain the power to approve or disapprove all treasury spends.

Additional guard rails will be put in place in order to stave off potential attacks, and in the case of a successful attack, prevent further attacks. These guardrails will include constraints on the
frequency of treasury transactions and amount of the treasury spend. These constraints will be enforced via consensus rules and will act to limit the impact of an attack, in the event that one occurs.

## Threat Model

By analyzing the threat model of stealing from the Treasury, we have arrived at a system that is secure against all but the most persistent and aggressive adversaries.  While the proposal put forward here involves on-chain voting to approve Treasury draws, we had originally hoped to have this process occur off-chain, with a Treasury draw being published after signatures were collected via Politeia.  Additionally, we have concluded that we require a Pi identity key to create draft Treasury spends, to prevent trivial stakeholder collusion from draining the Treasury.

Originally, we were keen to have draft Treasury spends be assembled off-chain via Politeia, where stakeholders would approve the draw by voting on the draft transaction.  The issue we found was that it is possible for Politeia operators to lie by omission, omitting votes against a spend to hit an approval threshold.  In short, if voting for a Treasury draw was 50/50, Politeia operators could simply omit some of the ‘no’ votes and get to 75/25 or similar.  To protect against the omission of votes, we have opted to have draft Treasury spends approved on-chain, where there are strong incentives against omission of votes.

After realizing that Treasury spends should be voted for on-chain, a second threat became apparent.  If any user can create draft Treasury spends, it is possible for a minority of stakeholders to approve a draft transaction to themselves, especially if other stakeholders are not actively monitoring the network.  Beyond the ability for minority stakeholders to collude and drain the treasury, roughly 50% of Decred’s stake is held by VSPs, which have voting wallets almost exclusively in colocation facilities.  Those familiar with colocation facilities know most can have their data easily accessed by local government officials or cloud service providers, meaning that even if VSPs are not colluding to drain the Treasury, they could be coerced to do so by their own cloud service providers or corresponding local governments.  To guard against collusion of stakeholders, VSPs, and theft of voting power via VSPs, we are proposing the existence of a designated Pi identity key, which would be used to generate draft Treasury spends.  This greatly reduces the stakeholder collusion attack surface by entrusting the generation of draft Treasury spends to the controllers of the Politeia platform.  At worst, this means that a holder of the Pi identity key can prevent payouts from occurring, but Treasury spends can only occur with the explicit approval of stakeholders.  In the medium term, we hope to remove this key and rely directly on our stakeholders for creating and approving Treasury spends.

## Implementation: Technical Overview

1. Every month Pi generates a treasury transaction that aggregates all invoices and creates an off-chain transaction that can be verified with the Pi draft key, a ed25519 keypair. Consensus shall reject transactions that are not signed by a valid Pi draft key or if the draft spend exceeds frequency or amount constraints. This off-chain transaction shall be published in Pi and shall be voted on on-chain for inclusion, after it is published on-chain. The vote must include the vote bits and a reference the transaction hash that is being voted on.
2. The treasury transaction must be approved by an on-chain vote for 2016 blocks (one week) with a 20% quorum and a 60% approval threshold.
3. If the treasury transaction is approved then the contractors can redeem their payouts after it matures.  If the treasury transaction is not approved by the stakeholders it is not considered a valid transaction and its outputs are not considered valid.
4. Treasury payouts are subjected to coinbase maturation.
5. There shall be auditing tools that cross check Pi activity with the draft spending transaction to ensure there is no nefarious activity.
6. Wallets shall receive the capability to trust or not trust the Pi draft key so that they can have a simple user interface for approving or disapproving draft treasury spends.

## Process technical details

Create a treasury state mechanism that tracks newly generated treasury funds and treasury spends.

Create 2 new opcodes:

* OP_TGEN: Replaces the current treasury script and alters the current consensus rules to add a new script that uses the OP_TGEN opcode which credits the treasury block reward to the treasury fund.

* OP_TSPEND: Cues dcrd to tally votes for the transaction hash that contains the opcode. The transaction must be signed by the Pi draft key to be considered valid.

OP_TSPEND shall have the following constraints:

* Prevent spending more than the total treasury funds.
* Prevent spending more than this months treasury accrued value + 50%
* Don't allow more than one approved OP_TSPEND per 28 days (8064 blocks)

OP_TSPEND transactions must be broadcast to the network so that recipients can redeem their funds, assuming it is approved.

Example draft treasury spend:
```
txid XYZ
in[0] = <Pi draft key> TSPEND
out[0] = OP_DUP OP_HASH160 <address1> OP_EQUAL OP_CHECKSIG
out[1] = OP_DUP OP_HASH160 <address2> OP_EQUAL OP_CHECKSIG
...
```

## Audit tools

dcrwallet and decrediton must implement vote auditing tools to verify that the stakeholder’s VSP(s) are casting votes according to the preferences set with each VSP. If the VSPs are not voting according to the will of the stakeholders, alarms need to start going off.

These tools shall implement a VSP receipt system that enables 3rd party verification of a fraud claim. This is important to prevent malicious actors from pretending that they hold a specific ticket.

## Future

This proposal may be expanded to add a backup draft key that can be used in emergency situations. This plan has not been finalized and may expand the scope of the proposal.

In order to make Decred ever more decentralized there is a desire to make voting simpler and more accessible for people that don't have the time or skills to deploy voting infrastructure. The VSPs have served the community well and they will always remain part of it, however, more individuals and organizations should retain control of their voting wallets. A future proposal will go into the details and possible solutions to this issue.

When future proposals are published the idea is to reduce and, ultimately eliminate, the need for the Pi draft key.

## Contractors

This work will be completed by Company 0 LLC.

We will consider completing this work with other contractors, provided they have the skills to contribute to implementing these changes.

## Timeline

This is a complex and hurdle filled project. While it seems relatively simple on the surface the underlying details are complex and arduous to implement. This proposal will require modifications of consensus, and with that comes an expansion of the current test framework. Once consensus changes are made they need to be voted on on-chain, in order to activate them. This type of problem is serial in nature and will therefore require prior steps to be completed before development can move on to the next item. That said, development, testing and voting will probably be on the order of 9-12 months. This estimate may have to be revised in case of unforeseen circumstances. A project that touches many critically important areas tend to be somewhat unpredictable.

## Projected Cost

This project will require three distinct skill sets. A consensus expert, a wallet expert and at least one additional developer for several months of FTE in each case. This puts the costs in the range of USD 200,000-250,000, and these funds will be drawn from a (forthcoming) budget that covers core development work.